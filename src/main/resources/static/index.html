<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tourist Map</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .filters {
      margin-bottom: 20px;
    }
    .filters select {
      margin-right: 10px;
      padding: 5px;
    }
    #container {
      display: flex;
      gap: 20px;
    }
    #map {
      flex: 1;
      height: 500px;
    }
    #infoPanel {
      width: 300px;
      height: 500px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background: #fff;
    }
    .lieux-list {
      margin-top: 20px;
    }
    .lieux-list ul {
      list-style-type: none;
      padding: 0;
    }
    .lieux-list li {
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Tourist Map</h1>

  <div class="filters">
    <select id="pays">
      <option value="" disabled selected>-- Choose a country --</option>
    </select>

    <select id="ville" disabled>
      <option value="" disabled selected>-- Choose a city --</option>
    </select>

    <select id="type">
      <option value="">All</option>
      <option value="tourisme">Tourism</option>
      <option value="hebergement">Accommodation</option>
      <option value="restaurant">Restaurant</option>
      <option value="transport">Transport</option>
    </select>

    <select id="mapType">
      <option value="roadmap">Map</option>
      <option value="satellite" selected>Satellite</option>
      <option value="hybrid">Hybrid</option>
      <option value="terrain">Terrain</option>
    </select>
  </div>

  <div id="container">
    <div id="map"></div>
    <div id="infoPanel">
      <h2>Info détaillée</h2>
      <p>Sélectionne un point sur la carte pour voir plus d'infos ici.</p>
      <div class="lieux-list">
        <h3>Lieux affichés</h3>
        <ul id="lieuxList"></ul>
      </div>
    </div>
  </div>

  <script>
    const paysCoords = {
      "Madagascar": { lat: -18.766947, lng: 46.869107 },
      "France": { lat: 46.603354, lng: 1.888334 },
      "USA": { lat: 37.0902, lng: -95.7129 }
    };

    const villeCoords = {
      "Antananarivo": { lat: -18.8792, lng: 47.5079 },
      "Paris": { lat: 48.8566, lng: 2.3522 },
      "New York": { lat: 40.7128, lng: -74.0060 }
    };
  </script>

  <script>
    let map;
    let markers = [];
    let hoverInfoWindow;
    let clickInfoWindow;

    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    function addMarker(lieu) {
      const iconUrl = `/images/${lieu.type || "default"}.svg`;

      const marker = new google.maps.Marker({
        position: { lat: lieu.latitude, lng: lieu.longitude },
        map: map,
        title: lieu.nom,
        icon: {
          url: iconUrl,
          scaledSize: new google.maps.Size(40, 40)
        }
      });

      marker.addListener("mouseover", () => {
        if (hoverInfoWindow) hoverInfoWindow.close();
        hoverInfoWindow = new google.maps.InfoWindow({
          content: `<div style="font-weight:bold;">${lieu.nom}</div>`,
          position: marker.getPosition()
        });
        hoverInfoWindow.open(map, marker);
      });

      marker.addListener("mouseout", () => {
        if (hoverInfoWindow) hoverInfoWindow.close();
      });

      marker.addListener("click", () => {
        if (clickInfoWindow) clickInfoWindow.close();

        const content = `
          <div style="min-width: 220px;">
            <h3>${lieu.nom}</h3>
            ${lieu.imageUrl ? `<img src="${lieu.imageUrl}" alt="${lieu.nom}" style="max-width: 100%; height: auto; margin-bottom: 10px;" />` : ""}
            <p><strong>Description:</strong> ${lieu.description || "Pas de description."}</p>
            ${lieu.siteWeb ? `<p><a href="${lieu.siteWeb}" target="_blank">Site web</a></p>` : ""}
            <p><strong>Type:</strong> ${lieu.type || "N/A"}</p>
            <p><strong>Coordonnées:</strong> ${lieu.latitude.toFixed(5)}, ${lieu.longitude.toFixed(5)}</p>
          </div>
        `;

        clickInfoWindow = new google.maps.InfoWindow({
          content: content,
          position: marker.getPosition()
        });

        clickInfoWindow.open(map, marker);

        const panel = document.getElementById("infoPanel");
        panel.querySelector("h2").textContent = lieu.nom;
        panel.querySelector("p").outerHTML = `
          ${lieu.imageUrl ? `<img src="${lieu.imageUrl}" alt="${lieu.nom}" style="width: 100%; margin-bottom: 10px;" />` : ""}
          <p><strong>Description:</strong> ${lieu.description || "Pas de description."}</p>
          ${lieu.siteWeb ? `<p><a href="${lieu.siteWeb}" target="_blank">Site web</a></p>` : ""}
          <p><strong>Type:</strong> ${lieu.type || "N/A"}</p>
          <p><strong>Coordonnées:</strong> ${lieu.latitude.toFixed(5)}, ${lieu.longitude.toFixed(5)}</p>
        `;
      });

      markers.push(marker);
    }
  </script>

  <script>
    function setupFilters() {
      const paysSelect = document.getElementById("pays");
      const villeSelect = document.getElementById("ville");
      const typeSelect = document.getElementById("type");

      fetch("/api/countries")
        .then(res => res.json())
        .then(paysList => {
          paysList.forEach(pays => {
            const opt = document.createElement("option");
            opt.value = pays.code;
            opt.innerText = pays.nom;
            paysSelect.appendChild(opt);
          });
        });

      paysSelect.addEventListener("change", () => {
        const paysCode = paysSelect.value;
        const paysNom = paysSelect.options[paysSelect.selectedIndex].text;

        villeSelect.innerHTML = '<option value="" disabled selected>-- Choose a city --</option>';
        villeSelect.disabled = true;

        fetch(`/api/cities?pays=${encodeURIComponent(paysCode)}`)
          .then(res => res.json())
          .then(villes => {
            villeSelect.disabled = false;
            villes.forEach(ville => {
              const opt = document.createElement("option");
              opt.value = ville.nom;
              opt.innerText = ville.nom;
              villeSelect.appendChild(opt);
            });
          });

        chargerEtAfficherLieux(paysNom, "", typeSelect.value);
      });

      villeSelect.addEventListener("change", () => {
        const paysNom = paysSelect.options[paysSelect.selectedIndex].text;
        const ville = villeSelect.value;
        chargerEtAfficherLieux(paysNom, ville, typeSelect.value);
      });

      typeSelect.addEventListener("change", () => {
        const paysNom = paysSelect.options[paysSelect.selectedIndex].text;
        const ville = villeSelect.value;
        chargerEtAfficherLieux(paysNom, ville, typeSelect.value);
      });
    }
  </script>

  <script>
    function chargerEtAfficherLieux(paysNom, ville, type) {
      clearMarkers();
      const listContainer = document.getElementById("lieuxList");
      listContainer.innerHTML = "";

      const params = new URLSearchParams();
      if (paysNom) params.append('pays', paysNom);
      if (ville) params.append('ville', ville);
      if (type) params.append('type', type);

      fetch(`/api/lieux?${params.toString()}`)
        .then(res => res.json())
        .then(lieux => {
          if (!paysNom && !ville && !type) {
            map.setCenter({ lat: 0, lng: 0 });
            map.setZoom(2);
          } else if (ville && villeCoords[ville]) {
            map.panTo(villeCoords[ville]);
            map.setZoom(12);
          } else if (paysNom && paysCoords[paysNom]) {
            map.panTo(paysCoords[paysNom]);
            map.setZoom(6);
          }

          lieux.forEach(lieu => {
            addMarker(lieu);

            const li = document.createElement("li");
            li.innerHTML = `<strong>${lieu.nom}</strong><br/><small>${lieu.type || "N/A"}</small>`;
            li.addEventListener("click", () => google.maps.event.trigger(markers.find(m => m.getTitle() === lieu.nom), 'click'));
            listContainer.appendChild(li);
          });

          if (lieux.length > 0 && !ville && !paysNom) {
            const bounds = new google.maps.LatLngBounds();
            lieux.forEach(lieu => bounds.extend({ lat: lieu.latitude, lng: lieu.longitude }));
            map.fitBounds(bounds);

            google.maps.event.addListenerOnce(map, "bounds_changed", function () {
              if (map.getZoom() > 15) map.setZoom(15);
            });
          }
        })
        .catch(err => console.error("Erreur lors du chargement des lieux :", err));
    }
  </script>

  <script>
    function initMap() {
      const mapTypeSelect = document.getElementById("mapType");

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 2,
        mapTypeId: mapTypeSelect.value
      });

      mapTypeSelect.addEventListener("change", () => {
        map.setMapTypeId(mapTypeSelect.value);
      });

      setupFilters();
      chargerEtAfficherLieux("", "", "");
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?callback=initMap" async defer></script>
</body>
</html>
